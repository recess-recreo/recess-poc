providers = ["node"]

[phases.setup]
nixPkgs = ["nodejs_20", "python3", "gcc", "gnumake"]
# Clear any existing caches to avoid conflicts with Railway cache mounting
cmds = ["rm -rf node_modules/.cache || true"]

[phases.install]
# Use npm install instead of npm ci to handle cache conflicts better
# npm ci is more strict about lockfile but can conflict with mounted caches
cmds = ["npm install --production=false"]

[phases.build]
cmds = ["NODE_OPTIONS='--max-old-space-size=4096' npm run build"]

[start]
cmd = "npm start"

[variables]
# Optimize for Railway build environment
NIXPACKS_NO_CACHE = "false"
# Prevent transformers.js from downloading models during build
TRANSFORMERS_CACHE = "/tmp/transformers-cache"

[caches]
# Only cache Next.js build cache, avoid node_modules cache conflicts
paths = [".next/cache"]