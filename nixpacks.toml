providers = ["node"]

[phases.setup]
nixPkgs = ["nodejs_20", "python3", "gcc", "gnumake"]

[phases.install]
# Force clean install without cache conflicts
cmds = ["rm -rf node_modules/.cache && npm install --production=false"]

[phases.build]
# Build with memory limit
cmds = ["NODE_OPTIONS='--max-old-space-size=4096' npm run build"]

[start]
cmd = "npm start"

[variables]
# Optimize for Railway build environment
NIXPACKS_NO_CACHE = "false"
# Prevent transformers.js from downloading models during build
TRANSFORMERS_CACHE = "/tmp/transformers-cache"

[caches]
# Only cache Next.js build cache, avoid node_modules cache conflicts
paths = [".next/cache"]